#!/bin/bash

# --- Ayarlar ve Renkler ---
BIBLE_DIR="."
CONFIG_DIR="$HOME/.config/bcli"
BOOKMARKS_FILE="$CONFIG_DIR/bookmarks.txt"

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
MAGENTA='\033[0;35m'
WHITE='\033[1;37m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m' # No Color

# --- Ä°konlar ---
ICON_BOOK="ðŸ“–"
ICON_WARN="âš "
ICON_ERROR="âŒ"
ICON_SEARCH="ðŸ”"
ICON_LIST="ðŸ“š"
ICON_SAVE="ðŸ’¾"
ICON_STAR="â­"

# --- Gereksinim ve Dizin KontrolÃ¼ ---
if ! command -v jq &>/dev/null; then
  echo -e "${RED}${ICON_ERROR} Hata:${NC} 'jq' paketi bulunamadÄ±. LÃ¼tfen yÃ¼kleyin."
  exit 1
fi

# Config dizinini oluÅŸtur (yoksa)
mkdir -p "$CONFIG_DIR"
touch "$BOOKMARKS_FILE"

# --- YardÄ±m MenÃ¼sÃ¼ ---
show_help() {
  echo -e "${MAGENTA}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
  echo -e "${MAGENTA}â”‚${NC}                 ${BOLD}${WHITE}${ICON_BOOK} B I B L E   C L I${NC}                    ${MAGENTA}â”‚${NC}"
  echo -e "${MAGENTA}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
  echo -e "${YELLOW}KULLANIM:${NC}"
  echo -e "  $0 \"Kitap AdÄ±\" [BÃ¶lÃ¼m] [Ayet] [--save]"
  echo -e "  $0 [SEÃ‡ENEK]"
  echo -e ""
  echo -e "${YELLOW}SEÃ‡ENEKLER:${NC}"
  echo -e "  -l, --list               ${DIM}Mevcut kitaplarÄ±n listesini gÃ¶sterir${NC}"

  echo -e "  -b, --bookmarks          ${DIM}Kaydedilen yer imlerini listeler${NC}"
  echo -e ""
  echo -e "${YELLOW}Ã–RNEKLER:${NC}"
  echo -e "  $0 \"Genesis\" 1 1         ${DIM}# Tek bir ayet getirir${NC}"
  echo -e "  $0 \"Genesis\" 1 1 --save  ${DIM}# Ayeti yer imlerine kaydeder${NC}"

  echo -e "${DIM}------------------------------------------------------------${NC}"
}

# --- KitaplarÄ± Listeleme ---
list_books() {
  echo -e "\n${BOLD}${CYAN}${ICON_LIST} Mevcut Kitap Listesi:${NC}\n"
  find "$BIBLE_DIR" -maxdepth 1 -name "*.json" | sed 's|.*/||; s|\.json$||' | sort | column -c 80
  echo ""
}

# --- Yer Ä°mlerini GÃ¶sterme ---
show_bookmarks() {
  if [ ! -s "$BOOKMARKS_FILE" ]; then
    echo -e "\n${YELLOW}${ICON_WARN} HenÃ¼z kaydedilmiÅŸ bir yer imi bulunmuyor.${NC}\n"
    exit 0
  fi
  echo -e "\n${BOLD}${MAGENTA}${ICON_STAR} Kaydedilen Yer Ä°mleri (${BOOKMARKS_FILE}):${NC}\n"
  cat "$BOOKMARKS_FILE"
  echo ""
}

# --- Global Arama (Search) ---
search_word() {
  local WORD="$1"
  echo -e "\n${DIM}${ICON_SEARCH} TÃ¼m kitaplarda '${BOLD}$WORD${DIM}' aranÄ±yor... Bu iÅŸlem birkaÃ§ saniye sÃ¼rebilir.${NC}\n"

  local FOUND=0
  for file in "$BIBLE_DIR"/*.json; do
    [ -e "$file" ] || continue
    book=$(basename "$file" .json)

    # jq ile bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf duyarsÄ±z (case-insensitive) regex aramasÄ±
    jq -r --arg q "$WORD" --arg b "$book" '
            .chapters[] | .chapter as $c | .verses[] | select(.text | test($q; "i")) |
            "\($b) \($c):\(.verse)|\(.text)"
        ' "$file" | while IFS='|' read -r ref text; do
      if [[ -n "$ref" ]]; then
        # EÅŸleÅŸen kelimenin altÄ±nÄ± Ã§izmek/renklendirmek iÃ§in grep kullanÄ±yoruz
        highlighted_text=$(echo "$text" | grep --color=always -i "$WORD")
        echo -e "${YELLOW}${BOLD}$ref${NC} ${CYAN}$highlighted_text${NC}"
        FOUND=1
      fi
    done
  done

  if [ $FOUND -eq 0 ]; then
    echo -e "${RED}${ICON_WARN} '${WORD}' kelimesi hiÃ§bir kitapta bulunamadÄ±.${NC}"
  fi
  echo ""
}

# --- Ana Parametre KontrolÃ¼ ---
if [[ $# -eq 0 ]] || [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
  show_help
  exit 0
fi

if [[ "$1" == "--list" ]] || [[ "$1" == "-l" ]]; then
  list_books
  exit 0
fi

if [[ "$1" == "--bookmarks" ]] || [[ "$1" == "-b" ]]; then
  show_bookmarks
  exit 0
fi

if [[ "$1" == "--search" ]] || [[ "$1" == "-s" ]]; then
  if [ -z "$2" ]; then
    echo -e "${RED}${ICON_ERROR} Hata:${NC} Aranacak kelimeyi girmediniz. Ã–rnek: $0 -s \"love\""
    exit 1
  fi
  search_word "$2"
  exit 0
fi

# Girdileri al (Okuma Modu)
BOOK_INPUT="$1"
CHAPTER="$2"
VERSE="$3"
SAVE_FLAG="$4"

FILE="$BIBLE_DIR/$BOOK_INPUT.json"

if [ ! -f "$FILE" ]; then
  echo -e "${RED}${ICON_ERROR} Hata:${NC} '${BOLD}$BOOK_INPUT${NC}' kitabÄ± bulunamadÄ±."
  exit 1
fi

if [ -z "$CHAPTER" ]; then
  echo -e "${RED}${ICON_WARN} Hata:${NC} LÃ¼tfen okumak istediÄŸiniz bÃ¶lÃ¼mÃ¼ belirtin."
  exit 1
fi

# JQ Sorgusu
if [ -z "$VERSE" ] || [ "$VERSE" == "--save" ]; then
  # EÄŸer 3. argÃ¼man --save ise, bÃ¶lÃ¼mÃ¼n tamamÄ±nÄ± istiyor demektir
  if [ "$VERSE" == "--save" ]; then
    SAVE_FLAG="--save"
    VERSE=""
  fi
  RESULT=$(jq -r --arg CH "$CHAPTER" \
    '.chapters[] | select(.chapter == $CH) | .verses[] | "\(.verse)| \(.text)"' \
    "$FILE")
else
  # Tek Ayet Sorgusu
  RESULT=$(jq -r --arg CH "$CHAPTER" --arg VS "$VERSE" \
    '.chapters[] | select(.chapter == $CH) | .verses[] | select(.verse == $VS) | .text' \
    "$FILE")
fi

# Ã‡Ä±ktÄ± KontrolÃ¼
if [ -z "$RESULT" ] || [ "$RESULT" == "null" ]; then
  echo -e "${RED}${ICON_ERROR} Hata:${NC} Belirtilen bÃ¶lÃ¼m veya ayet bu kitapta mevcut deÄŸil."
  exit 1
fi

# Terminale YazdÄ±rma
echo -e "\n${MAGENTA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${ICON_BOOK} ${BOLD}${WHITE}$BOOK_INPUT${NC} ${DIM}â¯${NC} ${YELLOW}BÃ¶lÃ¼m $CHAPTER${NC}${VERSE:+ ${DIM}â¯${NC} ${GREEN}Ayet $VERSE${NC}}"
echo -e "${MAGENTA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

if [ -z "$VERSE" ]; then
  echo "$RESULT" | while IFS='|' read -r v t; do
    if [[ -n "$v" && -n "$t" ]]; then
      echo -e "${YELLOW}${BOLD}$v${NC} ${CYAN}$t${NC}"
    fi
  done
  echo ""
else
  echo -e "${CYAN}$RESULT${NC}\n"
fi

# Yer Ä°mi Kaydetme MantÄ±ÄŸÄ±
if [[ "$SAVE_FLAG" == "--save" ]]; then
  if [ -z "$VERSE" ]; then
    echo -e "${RED}${ICON_WARN} UyarÄ±:${NC} Sadece tekil ayetler yer imlerine eklenebilir. TÃ¼m bÃ¶lÃ¼m kaydedilemez."
  else
    # Ayetin zaten ekli olup olmadÄ±ÄŸÄ±nÄ± kontrol et
    if grep -q "$BOOK_INPUT $CHAPTER:$VERSE" "$BOOKMARKS_FILE"; then
      echo -e "${YELLOW}${ICON_WARN} Bu ayet zaten yer imlerinde kayÄ±tlÄ±.${NC}\n"
    else
      echo -e "${YELLOW}${BOLD}$BOOK_INPUT $CHAPTER:$VERSE${NC} - ${RESULT}" >>"$BOOKMARKS_FILE"
      echo -e "${GREEN}${ICON_SAVE} BaÅŸarÄ±lÄ±:${NC} Ayet ${BOLD}~/.config/bcli/bookmarks.txt${NC} konumuna kaydedildi.\n"
    fi
  fi
fi

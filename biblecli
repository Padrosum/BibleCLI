#!/bin/bash

# ==========================================
# BIBLE CLI - Terminal Based Bible Reader
# ==========================================

# --- Ayarlar ve Renkler ---
BIBLE_DIR="."
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
MAGENTA='\033[0;35m'
WHITE='\033[1;37m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m' # No Color

# --- Ä°konlar ---
ICON_BOOK="ğŸ“–"
ICON_WARN="âš ï¸"
ICON_ERROR="âŒ"
ICON_SEARCH="ğŸ”"
ICON_LIST="ğŸ“š"

# --- Gereksinim KontrolÃ¼ ---
if ! command -v jq &> /dev/null; then
    echo -e "${RED}${ICON_ERROR} Hata:${NC} 'jq' paketi bulunamadÄ±. LÃ¼tfen yÃ¼kleyin."
    exit 1
fi

# --- YardÄ±m MenÃ¼sÃ¼ ---
show_help() {
    echo -e "${MAGENTA}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    echo -e "${MAGENTA}â”‚${NC}                 ${BOLD}${WHITE}${ICON_BOOK} B I B L E   C L I${NC}                    ${MAGENTA}â”‚${NC}"
    echo -e "${MAGENTA}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
    echo -e "${YELLOW}KULLANIM:${NC}"
    echo -e "  $0 \"Kitap AdÄ±\" [BÃ¶lÃ¼m] [Ayet]"
    echo -e ""
    echo -e "${YELLOW}Ã–RNEKLER:${NC}"
    echo -e "  $0 \"Genesis\" 1 1         ${DIM}# Tek bir ayet getirir${NC}"
    echo -e "  $0 \"John\" 3              ${DIM}# Bir bÃ¶lÃ¼mÃ¼n tÃ¼m ayetlerini listeler${NC}"
    echo -e "  $0 --list                ${DIM}# Mevcut kitaplarÄ±n listesini gÃ¶sterir${NC}"
    echo -e ""
    echo -e "${YELLOW}${ICON_WARN} NOT:${NC} Kitap adlarÄ± boÅŸluk iÃ§eriyorsa Ã§ift tÄ±rnak kullanÄ±n."
    echo -e "${DIM}------------------------------------------------------------${NC}"
}

# --- KitaplarÄ± Listeleme ---
list_books() {
    echo -e "\n${BOLD}${CYAN}${ICON_LIST} Mevcut Kitap Listesi:${NC}\n"
    # Sadece .json dosyalarÄ±nÄ± bul, uzantÄ±yÄ± sil ve dÃ¼zenli sÃ¼tun yap
    find "$BIBLE_DIR" -maxdepth 1 -name "*.json" | sed 's|.*/||; s|\.json$||' | sort | column -c 80
    echo ""
}

# --- Ana MantÄ±k ---

# Parametre kontrolÃ¼
if [[ $# -eq 0 ]] || [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
    show_help
    exit 0
fi

if [[ "$1" == "--list" ]] || [[ "$1" == "-l" ]]; then
    list_books
    exit 0
fi

# Girdileri al
BOOK_INPUT="$1"
CHAPTER="$2"
VERSE="$3"
FILE="$BIBLE_DIR/$BOOK_INPUT.json"

# Dosya kontrolÃ¼
if [ ! -f "$FILE" ]; then
    echo -e "${RED}${ICON_ERROR} Hata:${NC} '${BOLD}$BOOK_INPUT${NC}' kitabÄ± bulunamadÄ±."
    echo -e "Kitap listesini gÃ¶rmek iÃ§in: ${BOLD}$0 --list${NC}"
    exit 1
fi

# BÃ¶lÃ¼m girilmiÅŸ mi kontrolÃ¼
if [ -z "$CHAPTER" ]; then
    echo -e "${RED}${ICON_WARN} Hata:${NC} LÃ¼tfen okumak istediÄŸiniz bÃ¶lÃ¼mÃ¼ belirtin."
    echo -e "Ã–rnek: ${BOLD}$0 \"$BOOK_INPUT\" 1${NC}"
    exit 1
fi

echo -e "${DIM}${ICON_SEARCH} SorgulanÄ±yor: $BOOK_INPUT $CHAPTER${VERSE:+:$VERSE}...${NC}"

# JQ Sorgusu
if [ -z "$VERSE" ]; then
    # Sadece BÃ¶lÃ¼m Sorgusu: Ayet numarasÄ± ve metni '|' ile ayÄ±rÄ±yoruz
    RESULT=$(jq -r --arg CH "$CHAPTER" \
        '.chapters[] | select(.chapter == $CH) | .verses[] | "\(.verse)| \(.text)"' \
        "$FILE")
else
    # Tek Ayet Sorgusu
    RESULT=$(jq -r --arg CH "$CHAPTER" --arg VS "$VERSE" \
        '.chapters[] | select(.chapter == $CH) | .verses[] | select(.verse == $VS) | .text' \
        "$FILE")
fi

# Ã‡Ä±ktÄ± KontrolÃ¼ ve Renkli YazdÄ±rma
if [ -z "$RESULT" ] || [ "$RESULT" == "null" ]; then
    echo -e "${RED}${ICON_ERROR} Hata:${NC} Belirtilen bÃ¶lÃ¼m veya ayet bu kitapta mevcut deÄŸil."
else
    # Ãœst Bilgi Ã‡ubuÄŸu
    echo -e "\n${MAGENTA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${ICON_BOOK} ${BOLD}${WHITE}$BOOK_INPUT${NC} ${DIM}â¯${NC} ${YELLOW}BÃ¶lÃ¼m $CHAPTER${NC}${VERSE:+ ${DIM}â¯${NC} ${GREEN}Ayet $VERSE${NC}}"
    echo -e "${MAGENTA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

    # Ä°Ã§erik YazdÄ±rma
    if [ -z "$VERSE" ]; then
        # TÃ¼m bÃ¶lÃ¼mÃ¼ satÄ±r satÄ±r okuyup ayet numaralarÄ±nÄ± renklendiriyoruz
        echo "$RESULT" | while IFS='|' read -r v t; do
            if [[ -n "$v" && -n "$t" ]]; then
                echo -e "${YELLOW}${BOLD}$v${NC} ${CYAN}$t${NC}"
            fi
        done
        echo ""
    else
        # Tek Ayet okuma
        echo -e "${CYAN}$RESULT${NC}\n"
    fi
fi
